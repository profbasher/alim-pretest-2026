<!-- index.html - Ready to host on GitHub Pages -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Result Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; left: 0; top: 0; width: 100%; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-4">
      <h1 class="text-2xl font-semibold">College Result Store</h1>
      <div class="w-full sm:w-80 relative">
        <input id="searchInput" class="w-full pl-10 pr-10 py-2 rounded-lg border focus:outline-none" placeholder="Search by roll" />
        <button id="clearSearch" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hidden" aria-label="clear search">
          ‚úï
        </button>
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">üîç</span>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <section class="lg:col-span-1 bg-white p-4 rounded-lg shadow-sm">
        <form id="entryForm" class="space-y-3">
          <input type="hidden" id="recordId" />
          <div>
            <label class="block text-sm">Name</label>
            <input id="name" required class="w-full mt-1 p-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm">Roll</label>
            <input id="roll" required class="w-full mt-1 p-2 border rounded" />
          </div>

          <div class="grid grid-cols-2 gap-2">
            <template id="subjectTemplate">
              <div>
                <label class="block text-sm subject-label"></label>
                <input class="mt-1 p-2 border rounded subject-input" type="number" min="0" max="100" />
              </div>
            </template>
          </div>

          <div class="flex gap-2">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Save</button>
            <button id="resetBtn" type="button" class="px-4 py-2 rounded border">Reset</button>
          </div>
        </form>
      </section>

      <section class="lg:col-span-2 bg-white p-4 rounded-lg shadow-sm overflow-x-auto">
        <table class="min-w-full text-sm" id="resultsTable">
          <thead>
            <tr class="bg-slate-100 text-left">
              <th class="p-2">Name</th>
              <th class="p-2">Roll</th>
              <th class="p-2">Total</th>
              <th class="p-2">Grade</th>
              <th class="p-2">Point</th>
              <th class="p-2">Merit</th>
              <th class="p-2">Actions</th>
            </tr>
          </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- View / Print Modal -->
  <div id="viewModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-lg p-4 relative" id="print-area">
      <button id="closeModal" class="absolute right-3 top-3 text-slate-600">‚úï</button>
      <div id="modalContent"></div>
      <div class="mt-4 flex gap-2 no-print">
        <button id="printBtn" class="px-4 py-2 border rounded">Print</button>
        <button id="modalClose2" class="px-4 py-2 border rounded">Close</button>
      </div>
    </div>
  </div>

  <script>
    // CONFIG: replace with your deployed Google Apps Script web app url
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxEWlgVEiZwVd-F71OzJQBOjZpgJQh5fiNWg8y2pL70YJ9yMk64aER-iAOshw-vPkrv/exec';

    const subjects = [
      { key: 'quran_mazid', label: 'Quran Mazid' },
      { key: 'hadis', label: 'Hadis' },
      { key: 'fikah_1', label: 'Fikah 1' },
      { key: 'fikah_2', label: 'Fikah 2' },
      { key: 'physics_2', label: 'Physics 2' },
      { key: 'bengali_1', label: 'Bengali 1' },
      { key: 'bengali_2', label: 'Bengali 2' },
      { key: 'english_1', label: 'English 1' },
      { key: 'english_2', label: 'English 2' },
      { key: 'arabic_1', label: 'Arabic 1' },
      { key: 'arabic_2', label: 'Arabic 2' },
      { key: 'biology_2', label: 'Biology 2' },
      { key: 'ict', label: 'ICT' },
      { key: 'chemistry_2', label: 'Chemistry 2' },
      { key: 'history', label: 'History' },
      { key: 'mantik', label: 'Mantik' },
      { key: 'civics', label: 'Civics' },
      { key: 'higher_math', label: 'Higher Math' }
    ];

    const gradeScale = [
      { min: 80, max: 100, letter: 'A+', point: 5.0 },
      { min: 70, max: 79, letter: 'A', point: 4.0 },
      { min: 60, max: 69, letter: 'A-', point: 3.5 },
      { min: 50, max: 59, letter: 'B', point: 3.0 },
      { min: 40, max: 49, letter: 'C', point: 2.0 },
      { min: 33, max: 39, letter: 'D', point: 1.0 },
      { min: 0,  max: 32, letter: 'F', point: 0.0 }
    ];

    // build form fields
    const template = document.getElementById('subjectTemplate');
    const form = document.getElementById('entryForm');
    const resetBtn = document.getElementById('resetBtn');
    const resultsBody = document.getElementById('resultsBody');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');

    subjects.forEach(s => {
      const clone = template.content.cloneNode(true);
      const label = clone.querySelector('.subject-label');
      const input = clone.querySelector('.subject-input');
      label.textContent = s.label;
      input.id = s.key;
      input.name = s.key;
      document.getElementById('entryForm').insertBefore(clone, form.querySelector('.flex'));
    });

    // util
    function toNumber(v) {
      const n = parseFloat(v);
      return isNaN(n) ? 0 : Math.max(0, Math.min(100, n));
    }

    function gradeForPercentage(p) {
      for (const g of gradeScale) {
        if (p >= g.min && p <= g.max) return { letter: g.letter, point: g.point };
      }
      return { letter: 'F', point: 0.0 };
    }

    function calculateResult(subjectValues) {
      const keys = Object.keys(subjectValues);
      let total = 0;
      let count = 0;
      const points = [];
      for (const k of keys) {
        const v = toNumber(subjectValues[k]);
        total += v;
        count++;
        const gp = gradeForPercentage(v).point;
        points.push(gp);
      }
      const avgPercent = count ? (total / count) : 0;
      const avgPoint = points.length ? (points.reduce((a,b)=>a+b,0)/points.length) : 0;
      const { letter } = gradeForPercentage(avgPercent);
      return {
        total: Math.round(total),
        grade: letter,
        point: Number(avgPoint.toFixed(2)),
        merit: Number(avgPercent.toFixed(2))
      }
    }

    // API
    async function apiGet(params = {}) {
      const qs = new URLSearchParams(params).toString();
      const url = GAS_URL + (qs ? ('?'+qs) : '');
      const res = await fetch(url);
      return res.json();
    }
    async function apiPost(body = {}) {
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      return res.json();
    }

    // rendering
    let records = [];
    async function loadAll() {
      try {
        const r = await apiGet({ action: 'list' });
        if (r && r.success) {
          records = r.data.map(normalizeRecord);
          renderTable(records);
        }
      } catch (err) { console.error(err); }
    }

    function normalizeRecord(raw) {
      const rec = {};
      // normalize string keys, ensure numeric fields are numbers
      rec.name = raw.name || raw.Name || '';
      rec.roll = raw.roll || raw.Roll || '';
      subjects.forEach(s => rec[s.key] = raw[s.key] !== undefined ? raw[s.key] : '');
      rec.total = raw.total || raw.Total || '';
      rec.grade = raw.grade || raw.Grade || '';
      rec.point = raw.point || raw.Point || '';
      rec.merit = raw.merit || raw.Merit || '';
      rec.id = raw.id || '';
      rec.created_at = raw.created_at || '';
      return rec;
    }

    function renderTable(list) {
      resultsBody.innerHTML = '';
      if (!list || !list.length) {
        resultsBody.innerHTML = '<tr><td class="p-2" colspan="7">No records</td></tr>';
        return;
      }
      for (const r of list) {
        const tr = document.createElement('tr');
        tr.className = 'border-b';
        tr.innerHTML = `
          <td class="p-2">${escapeHtml(r.name)}</td>
          <td class="p-2">${escapeHtml(r.roll)}</td>
          <td class="p-2">${escapeHtml(r.total)}</td>
          <td class="p-2">${escapeHtml(r.grade)}</td>
          <td class="p-2">${escapeHtml(r.point)}</td>
          <td class="p-2">${escapeHtml(r.merit)}</td>
          <td class="p-2">
            <div class="flex gap-1">
              <button data-id="${r.id}" class="viewBtn px-2 py-1 border rounded text-sm">View</button>
              <button data-id="${r.id}" class="editBtn px-2 py-1 border rounded text-sm">Edit</button>
              <button data-id="${r.id}" class="deleteBtn px-2 py-1 border rounded text-sm">Delete</button>
              <button data-id="${r.id}" class="printRowBtn px-2 py-1 border rounded text-sm">Print</button>
            </div>
          </td>
        `;
        resultsBody.appendChild(tr);
      }

      // attach actions
      document.querySelectorAll('.viewBtn').forEach(b => b.addEventListener('click', e => viewRecord(e.target.dataset.id)));
      document.querySelectorAll('.editBtn').forEach(b => b.addEventListener('click', e => editRecord(e.target.dataset.id)));
      document.querySelectorAll('.deleteBtn').forEach(b => b.addEventListener('click', e => deleteRecord(e.target.dataset.id)));
      document.querySelectorAll('.printRowBtn').forEach(b => b.addEventListener('click', e => printRow(e.target.dataset.id)));
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // form handling
    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();
      const payload = {};
      payload.name = document.getElementById('name').value.trim();
      payload.roll = document.getElementById('roll').value.trim();
      subjects.forEach(s => payload[s.key] = toNumber(document.getElementById(s.key).value || 0));
      const calc = calculateResult(Object.fromEntries(subjects.map(s=>[s.key, payload[s.key]])));
      payload.total = calc.total;
      payload.grade = calc.grade;
      payload.point = calc.point;
      payload.merit = calc.merit;

      const id = document.getElementById('recordId').value;
      if (id) {
        payload.action = 'update';
        payload.id = id;
        const res = await apiPost(payload);
        if (res && res.success) {
          await loadAll();
          form.reset();
          document.getElementById('recordId').value = '';
        }
      } else {
        payload.action = 'new-entry';
        const res = await apiPost(payload);
        if (res && res.success) {
          await loadAll();
          form.reset();
        }
      }
    });

    resetBtn.addEventListener('click', function () {
      form.reset();
      document.getElementById('recordId').value = '';
    });

    // actions
    function findById(id) { return records.find(r=>String(r.id)===String(id)); }
    async function viewRecord(id) {
      const r = findById(id);
      if (!r) return;
      const html = generateDetailHtml(r);
      document.getElementById('modalContent').innerHTML = html;
      document.getElementById('viewModal').classList.remove('hidden');
    }
    function generateDetailHtml(r) {
      const rows = subjects.map(s => `<tr><td class="p-1 border">${s.label}</td><td class="p-1 border">${escapeHtml(r[s.key])}</td></tr>`).join('');
      return `
        <div>
          <h2 class="text-xl font-semibold mb-2">${escapeHtml(r.name)} ‚Äî Roll: ${escapeHtml(r.roll)}</h2>
          <table class="w-full border-collapse">
            ${rows}
            <tr><td class="p-1 border">Total</td><td class="p-1 border">${escapeHtml(r.total)}</td></tr>
            <tr><td class="p-1 border">Grade</td><td class="p-1 border">${escapeHtml(r.grade)}</td></tr>
            <tr><td class="p-1 border">Point</td><td class="p-1 border">${escapeHtml(r.point)}</td></tr>
            <tr><td class="p-1 border">Merit (%)</td><td class="p-1 border">${escapeHtml(r.merit)}</td></tr>
          </table>
        </div>
      `;
    }

    function editRecord(id) {
      const r = findById(id);
      if (!r) return;
      document.getElementById('name').value = r.name;
      document.getElementById('roll').value = r.roll;
      subjects.forEach(s => document.getElementById(s.key).value = r[s.key]);
      document.getElementById('recordId').value = r.id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteRecord(id) {
      if (!confirm('Delete this record?')) return;
      const res = await apiPost({ action: 'delete', id });
      if (res && res.success) {
        await loadAll();
      } else {
        alert('Delete failed');
      }
    }

    function printRow(id) {
      const r = findById(id);
      if (!r) return;
      const prev = document.getElementById('modalContent').innerHTML;
      document.getElementById('modalContent').innerHTML = generateDetailHtml(r);
      document.getElementById('viewModal').classList.remove('hidden');
      setTimeout(()=>window.print(), 300);
    }

    // search
    searchInput.addEventListener('input', function () {
      const q = this.value.trim();
      if (q.length) clearSearch.classList.remove('hidden'); else clearSearch.classList.add('hidden');
      if (!q) { renderTable(records); return; }
      const filtered = records.filter(r => String(r.roll).toLowerCase().includes(q.toLowerCase()));
      renderTable(filtered);
    });
    clearSearch.addEventListener('click', function () {
      searchInput.value = '';
      searchInput.dispatchEvent(new Event('input'));
    });

    // modal controls
    document.getElementById('closeModal').addEventListener('click', ()=>document.getElementById('viewModal').classList.add('hidden'));
    document.getElementById('modalClose2').addEventListener('click', ()=>document.getElementById('viewModal').classList.add('hidden'));
    document.getElementById('printBtn').addEventListener('click', ()=>window.print());

    // load
    loadAll();
  </script>
</body>
</html>
