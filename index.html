<!-- index.html — ready to host on GitHub Pages. Put your Apps Script Web App URL into API_BASE. -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Result Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="max-w-7xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-semibold">College Result Store</h1>
      <div class="flex items-center gap-3">
        <div class="relative">
          <input id="search" placeholder="Search by roll..." class="pl-3 pr-8 py-2 rounded border w-64 focus:outline-none" />
          <button id="clearSearch" title="Clear" class="absolute right-1 top-1/2 -translate-y-1/2 p-1" aria-label="clear">
            <!-- Cross icon -->
            <svg id="clearIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" class="opacity-50">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <button id="newBtn" class="bg-blue-600 text-white px-4 py-2 rounded">New Result</button>
      </div>
    </header>

    <main>
      <section class="bg-white shadow rounded p-4 mb-4 overflow-x-auto">
        <table id="resultsTable" class="min-w-full divide-y">
          <thead id="thead" class="bg-gray-100">
          </thead>
          <tbody id="tbody" class="bg-white"></tbody>
        </table>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-40">
    <div class="bg-white rounded-lg w-full max-w-3xl p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 id="modalTitle" class="text-lg font-semibold"></h2>
        <button id="closeModal" class="text-gray-500">Close</button>
      </div>
      <form id="form" class="grid grid-cols-1 gap-3">
        <!-- form fields inserted dynamically -->
        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="saveBtn" class="bg-green-600 text-white px-4 py-2 rounded">Save</button>
          <button type="button" id="cancelBtn" class="bg-gray-300 px-4 py-2 rounded">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <template id="rowTemplate">
    <tr class="hover:bg-gray-50">
      <!-- dynamic cells -->
    </tr>
  </template>

  <script>
  // ---------- CONFIG ----------
  const API_BASE = 'https://script.google.com/macros/s/AKfycby6Jsu7kRLoc7bp6hGxY65u5RvMpLhfsgKrykhsZouNu9YfcgEPNnmPOmPd3YJdIjYW/exec'; // e.g. https://script.google.com/macros/s/AKfy.../exec
  const SHEET_HEADERS = ["Name","Roll","Quran Mazid","Hadis","Fikah 1","Fikah 2/ Physics 2","Bengali 1","Bengali 2","English 1","English 2","Arabic 1","Arabic 2/Biology 2","ICT","Camistry 2/History","Mantik","Civics/Higher Math","Total","Grade","Point","Merit"];
  // ----------------------------

  const state = { rows: [], headers: SHEET_HEADERS.slice() };

  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const searchInput = document.getElementById('search');
  const clearSearchBtn = document.getElementById('clearSearch');
  const newBtn = document.getElementById('newBtn');
  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const form = document.getElementById('form');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const closeModal = document.getElementById('closeModal');

  // Build table header
  function renderHeader() {
    const tr = document.createElement('tr');
    state.headers.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.className = 'text-left px-3 py-2 text-sm font-medium text-gray-600';
      tr.appendChild(th);
    });
    const thAct = document.createElement('th');
    thAct.textContent = 'Actions';
    thAct.className = 'text-left px-3 py-2 text-sm font-medium text-gray-600';
    tr.appendChild(thAct);
    thead.innerHTML = '';
    thead.appendChild(tr);
  }

  // Fetch all rows
  async function fetchRows() {
    const url = API_BASE + '?action=list';
    const r = await fetch(url);
    const data = await r.json();
    state.rows = data.rows || [];
    computeMeritAndGPA();
    renderRows(state.rows);
  }

  // Compute merit ranking from points or total: higher Point then higher Total
  function computeMeritAndGPA() {
    // ensure Point numeric
    state.rows.forEach(r => r.Point = Number(r.Point || 0));
    // sort copy by Point desc then Total desc
    const sorted = state.rows.slice().sort((a,b) => {
      if (b.Point !== a.Point) return b.Point - a.Point;
      return Number(b.Total || 0) - Number(a.Total || 0);
    });
    sorted.forEach((row, idx) => {
      row._meritRank = idx + 1;
    });
    // attach to original rows by roll or _row
    state.rows.forEach(r => {
      const found = sorted.find(s => s._row === r._row);
      r.Merit = found ? found._meritRank : '';
    });
  }

  function renderRows(rows) {
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.className = 'border-b';
      state.headers.forEach(h => {
        const td = document.createElement('td');
        td.className = 'px-3 py-2 text-sm';
        td.textContent = r[h] !== undefined ? r[h] : '';
        tr.appendChild(td);
      });
      const tdActions = document.createElement('td');
      tdActions.className = 'px-3 py-2 text-sm space-x-2';
      const viewBtn = createAction('View', () => openView(r));
      const editBtn = createAction('Edit', () => openEdit(r));
      const delBtn = createAction('Delete', () => doDelete(r));
      const printBtn = createAction('Print', () => doPrint(r));
      tdActions.appendChild(viewBtn);
      tdActions.appendChild(editBtn);
      tdActions.appendChild(delBtn);
      tdActions.appendChild(printBtn);
      tr.appendChild(tdActions);
      tbody.appendChild(tr);
    });
  }

  function createAction(label, fn) {
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.className = 'text-xs px-2 py-1 rounded border';
    btn.addEventListener('click', fn);
    return btn;
  }

  // Modal helpers
  function openModal(title) {
    modalTitle.textContent = title;
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }
  function closeModalFunc() {
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    form.innerHTML = '';
  }

  // New
  newBtn.addEventListener('click', () => {
    buildForm();
    openModal('New Result');
  });

  // Build form fields dynamically from headers
  function buildForm(data = {}) {
    form.innerHTML = '';
    state.headers.forEach(h => {
      if (['Total','Grade','Point','Merit'].includes(h)) return; // computed
      const wrap = document.createElement('div');
      wrap.className = 'grid grid-cols-1 gap-1';
      const label = document.createElement('label');
      label.className = 'text-sm font-medium';
      label.textContent = h;
      const input = document.createElement('input');
      input.name = h;
      input.className = 'border rounded px-2 py-2';
      input.value = data[h] || '';
      if (h === 'Roll') input.required = true;
      if (h !== 'Name' && h !== 'Roll') {
        input.type = 'number';
        input.min = 0;
        input.max = 100;
      }
      wrap.appendChild(label);
      wrap.appendChild(input);
      form.appendChild(wrap);
    });
    // hidden _row if editing
    if (data._row) {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = '_row';
      hidden.value = data._row;
      form.appendChild(hidden);
    }
  }

  // View modal
  function openView(row) {
    form.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 gap-2';
    state.headers.forEach(h => {
      const p = document.createElement('p');
      p.className = 'text-sm';
      p.innerHTML = '<strong>' + h + ':</strong> ' + (row[h] || '');
      grid.appendChild(p);
    });
    form.appendChild(grid);
    saveBtn.style.display = 'none';
    openModal('View Result');
  }

  // Edit modal
  function openEdit(row) {
    buildForm(row);
    saveBtn.style.display = '';
    openModal('Edit Result');
  }

  // Save handler (add or edit)
  saveBtn.addEventListener('click', async () => {
    const fd = new FormData(form);
    const obj = {};
    for (const [k,v] of fd.entries()) obj[k] = v;
    const action = obj._row ? 'edit' : 'add';
    obj.action = action;
    // convert numeric fields
    state.headers.forEach(h => {
      if (!['Name','Roll','Total','Grade','Point','Merit'].includes(h) && obj[h] !== undefined) {
        obj[h] = obj[h] === '' ? 0 : Number(obj[h]);
      }
    });
    const res = await fetch(API_BASE, {
      method: 'POST',
      body: JSON.stringify(obj),
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await res.json();
    await fetchRows();
    closeModalFunc();
  });

  cancelBtn.addEventListener('click', () => {
    closeModalFunc();
  });
  closeModal.addEventListener('click', () => {
    closeModalFunc();
  });

  // Delete
  async function doDelete(row) {
    if (!confirm('Delete result for roll ' + row.Roll + ' ?')) return;
    const url = API_BASE + '?action=delete&row=' + encodeURIComponent(row._row);
    await fetch(url, { method: 'GET' });
    await fetchRows();
  }

  // Print — open a new window with printable content
  function doPrint(row) {
    const win = window.open('', '_blank', 'width=800,height=600');
    const html = renderPrintableHTML(row);
    win.document.write(html);
    win.document.close();
    win.focus();
    win.print();
  }

  function renderPrintableHTML(row) {
    const title = 'Result — ' + (row.Name || '') + ' (' + (row.Roll || '') + ')';
    const rowsHtml = state.headers.map(h => {
      if (['Total','Grade','Point','Merit'].includes(h)) return `<tr><td style="padding:6px;border:1px solid #ddd"><strong>${h}</strong></td><td style="padding:6px;border:1px solid #ddd">${row[h]||''}</td></tr>`;
      return `<tr><td style="padding:6px;border:1px solid #ddd">${h}</td><td style="padding:6px;border:1px solid #ddd">${row[h]||''}</td></tr>`;
    }).join('');
    return `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title><style>body{font-family:Arial;padding:20px}table{border-collapse:collapse;width:100%}</style></head><body><h2>${title}</h2><table>${rowsHtml}</table></body></html>`;
  }

  // Search behavior: client enters text; on input, call search API and update table; cross icon clears.
  let searchTimer = null;
  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(runSearch, 250);
  });

  clearSearchBtn.addEventListener('click', () => {
    searchInput.value = '';
    runSearch();
  });

  async function runSearch() {
    const q = searchInput.value.trim();
    if (!q) {
      renderRows(state.rows);
      return;
    }
    const url = API_BASE + '?action=search&roll=' + encodeURIComponent(q);
    const r = await fetch(url);
    const data = await r.json();
    renderRows(data.rows || []);
  }

  // init
  (async function init(){
    renderHeader();
    await fetchRows();
  })();

  </script>
</body>
</html>
