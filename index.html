<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Result Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-semibold">College Result Store</h1>
      <div class="flex items-center gap-3">
        <div class="relative">
          <input id="search" type="search" placeholder="Search by roll" class="pl-10 pr-8 py-2 border rounded-lg focus:outline-none focus:ring" />
          <svg id="searchIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-2.5 text-gray-400 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.9 14.32a8 8 0 111.414-1.414l3.387 3.387-1.414 1.414-3.387-3.387zM8 14a6 6 0 100-12 6 6 0 000 12z" clip-rule="evenodd" /></svg>
          <button id="clearSearch" class="absolute right-1 top-1.5 p-1 rounded-full hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
          </button>
        </div>
        <button id="addBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Add Result</button>
      </div>
    </header>

    <main>
      <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table id="resultsTable" class="min-w-full divide-y">
          <thead class="bg-gray-100">
            <tr id="tableHead" class="text-left text-sm font-medium text-gray-700"></tr>
          </thead>
          <tbody id="tableBody" class="divide-y"></tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Modal Form -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
    <div class="bg-white w-full max-w-3xl rounded-lg p-6 overflow-auto max-h-[90vh]">
      <h2 id="modalTitle" class="text-xl font-semibold mb-4">Add / Edit Result</h2>
      <form id="resultForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium">Name</label>
          <input name="Name" required class="mt-1 block w-full border rounded p-2" />
        </div>
        <div>
          <label class="block text-sm font-medium">Roll</label>
          <input name="Roll" required class="mt-1 block w-full border rounded p-2" />
        </div>

        <!-- Subjects fields -->
        <template id="subjectFieldsTemplate">
          <div>
            <label class="block text-sm font-medium subject-label"></label>
            <input type="number" min="0" max="100" step="0.01" class="mt-1 block w-full border rounded p-2 subject-input" />
          </div>
        </template>

        <div class="md:col-span-2 flex justify-end gap-2 mt-2">
          <button type="button" id="cancelBtn" class="px-4 py-2 border rounded">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Print Template -->
  <div id="printArea" class="hidden"></div>

  <script>
    // CONFIG: set this to your deployed Google Apps Script web app URL
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzvpP4Hm1Chq2U0gyc-29KtuMzBZK14S8s8U8mzHxxPsz8IwPLp8ZCavuZgDvE4Bbvt/exec';

    const SUBJECTS = [
      "Quran Mazid","Hadis","Fikah 1","Fikah 2/ Physics 2","Bengali 1","Bengali 2",
      "English 1","English 2","Arabic 1","Arabic 2/Biology 2","ICT","Camistry 2/History",
      "Mantik","Civics/Higher Math"
    ];

    // Grade scale
    function percentToGrade(p) {
      p = Number(p);
      if (isNaN(p)) return { grade: 'F', point: 0 };
      if (p >= 80) return { grade: 'A+', point: 5.0 };
      if (p >= 70) return { grade: 'A', point: 4.0 };
      if (p >= 60) return { grade: 'A-', point: 3.5 };
      if (p >= 50) return { grade: 'B', point: 3.0 };
      if (p >= 40) return { grade: 'C', point: 2.0 };
      if (p >= 33) return { grade: 'D', point: 1.0 };
      return { grade: 'F', point: 0.0 };
    }

    function meritFromGPA(gpa) {
      if (gpa >= 4.5) return 'Outstanding';
      if (gpa >= 3.5) return 'First Class';
      if (gpa >= 2.5) return 'Second Class';
      if (gpa >= 2.0) return 'Third Class';
      return 'Fail';
    }

    // Build table head
    const tableHead = document.getElementById('tableHead');
    const tableBody = document.getElementById('tableBody');
    const headCols = ['Name','Roll', ...SUBJECTS, 'Total','Grade','Point','Merit','Actions'];
    headCols.forEach(h => {
      const th = document.createElement('th');
      th.className = 'px-4 py-3';
      th.textContent = h;
      tableHead.appendChild(th);
    });

    // Modal and form
    const modal = document.getElementById('modal');
    const resultForm = document.getElementById('resultForm');
    const subjectTemplate = document.getElementById('subjectFieldsTemplate');
    const modalTitle = document.getElementById('modalTitle');
    let editingId = null;

    function openModal(edit = false, data = null) {
      editingId = edit && data ? data.ID : null;
      modalTitle.textContent = edit ? 'Edit Result' : 'Add Result';
      resultForm.reset();

      // clear existing subject inputs
      const existing = resultForm.querySelectorAll('.subject-row');
      existing.forEach(e => e.remove());

      SUBJECTS.forEach((s, idx) => {
        const node = subjectTemplate.content.cloneNode(true);
        const wrapper = document.createElement('div');
        wrapper.className = 'subject-row';
        const label = node.querySelector('.subject-label');
        label.textContent = s;
        const input = node.querySelector('.subject-input');
        input.name = s;
        if (data && data[s] !== undefined) input.value = data[s];
        wrapper.appendChild(node);
        // insert before buttons (which are last)
        resultForm.insertBefore(wrapper, resultForm.lastElementChild);
      });

      if (data) {
        resultForm.querySelector('[name="Name"]').value = data.Name || '';
        resultForm.querySelector('[name="Roll"]').value = data.Roll || '';
      }

      modal.classList.remove('hidden');
      modal.style.display = 'flex';
    }

    document.getElementById('addBtn').addEventListener('click', () => openModal(false, null));
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    function closeModal() {
      modal.classList.add('hidden');
      modal.style.display = 'none';
      editingId = null;
    }

    // Fetch list from backend
    async function fetchList() {
      const res = await fetch(`${SCRIPT_URL}?action=list`);
      const json = await res.json();
      return json.success ? json.data : [];
    }

    // Render table rows
    async function renderTable(filterRoll = '') {
      tableBody.innerHTML = '';
      const data = await fetchList();
      const rows = data.filter(r => String(r.Roll || '').toLowerCase().includes(String(filterRoll).toLowerCase()));
      rows.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        // Name, Roll
        const makeTd = (txt, classes='px-4 py-2') => {
          const td = document.createElement('td');
          td.className = classes + ' align-top text-sm';
          td.innerHTML = txt;
          return td;
        };
        tr.appendChild(makeTd(escapeHtml(row.Name || '')));
        tr.appendChild(makeTd(escapeHtml(row.Roll || '')));

        // Subjects and total calculation
        let total = 0;
        let count = 0;
        SUBJECTS.forEach(s => {
          const val = parseFloat(row[s]) || 0;
          total += val;
          count++;
          tr.appendChild(makeTd(String(val)));
        });

        const avgPercent = count ? (total / count) : 0;
        const gradeInfo = percentToGrade(avgPercent);
        const gpa = calculateGPAFromRow(row);

        tr.appendChild(makeTd(total.toFixed(2)));
        tr.appendChild(makeTd(escapeHtml(gradeInfo.grade)));
        tr.appendChild(makeTd(gpa.toFixed(2)));
        tr.appendChild(makeTd(escapeHtml(meritFromGPA(gpa))));

        // Actions
        const actionsTd = document.createElement('td');
        actionsTd.className = 'px-4 py-2';
        const editBtn = actionButton('Edit', () => openForEdit(row));
        const delBtn = actionButton('Delete', () => deleteRow(row.ID));
        const viewBtn = actionButton('View', () => viewRow(row));
        const printBtn = actionButton('Print', () => printRow(row));
        actionsTd.appendChild(editBtn);
        actionsTd.appendChild(delBtn);
        actionsTd.appendChild(viewBtn);
        actionsTd.appendChild(printBtn);
        tr.appendChild(actionsTd);

        tableBody.appendChild(tr);
      });
    }

    function actionButton(label, cb) {
      const btn = document.createElement('button');
      btn.className = 'mr-2 mb-1 px-3 py-1 rounded text-sm border hover:bg-gray-100';
      btn.textContent = label;
      btn.addEventListener('click', cb);
      return btn;
    }

    function escapeHtml(unsafe) {
      return String(unsafe || '').replace(/[&<"'>]/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m];
      });
    }

    // Calculate GPA from row by converting each subject to grade point and averaging
    function calculateGPAFromRow(row) {
      let totalPoints = 0;
      let count = 0;
      SUBJECTS.forEach(s => {
        const p = Number(row[s]);
        if (!isNaN(p)) {
          totalPoints += percentToGrade(p).point;
          count++;
        }
      });
      return count ? totalPoints / count : 0;
    }

    async function openForEdit(row) {
      // fetch full object from backend to ensure latest
      const res = await fetch(`${SCRIPT_URL}?action=get&id=${encodeURIComponent(row.ID)}`);
      const j = await res.json();
      if (j.success && j.data) openModal(true, j.data);
      else openModal(true, row);
    }

    async function deleteRow(id) {
      if (!confirm('Delete this record?')) return;
      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'delete', ID: id }),
        headers: { 'Content-Type': 'application/json' }
      });
      const j = await res.json();
      if (j.success) await renderTable(document.getElementById('search').value);
      else alert('Delete failed');
    }

    function viewRow(row) {
      const html = buildPrintHtml(row);
      const w = window.open('', '_blank', 'width=800,height=900');
      w.document.write(html);
      w.document.close();
    }

    function printRow(row) {
      const html = buildPrintHtml(row);
      const w = window.open('', '_blank', 'width=800,height=900');
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    function buildPrintHtml(row) {
      const gpa = calculateGPAFromRow(row);
      const overallGrade = percentToGrade(averagePercentFromRow(row)).grade;
      const rowsHtml = SUBJECTS.map(s => `<tr><td>${escapeHtml(s)}</td><td>${escapeHtml(row[s]||'0')}</td><td>${percentToGrade(Number(row[s])||0).grade}</td><td>${percentToGrade(Number(row[s])||0).point.toFixed(2)}</td></tr>`).join('');
      return `
        <html><head>
          <title>Result - ${escapeHtml(row.Name||'')}</title>
          <style>body{font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding:20px} table{width:100%;border-collapse:collapse}td,th{border:1px solid #ddd;padding:8px}</style>
        </head>
        <body>
          <h1>Result Card</h1>
          <p><strong>Name:</strong> ${escapeHtml(row.Name||'')}</p>
          <p><strong>Roll:</strong> ${escapeHtml(row.Roll||'')}</p>
          <table>
            <thead><tr><th>Subject</th><th>Mark</th><th>Grade</th><th>Point</th></tr></thead>
            <tbody>
              ${rowsHtml}
            </tbody>
          </table>
          <p><strong>Total:</strong> ${(computeTotalFromRow(row)).toFixed(2)} &nbsp;&nbsp; <strong>GPA:</strong> ${gpa.toFixed(2)} &nbsp;&nbsp; <strong>Grade:</strong> ${escapeHtml(overallGrade)} &nbsp;&nbsp; <strong>Merit:</strong> ${escapeHtml(meritFromGPA(gpa))}</p>
        </body></html>
      `;
    }

    function averagePercentFromRow(row) {
      let tot = 0; let c = 0;
      SUBJECTS.forEach(s => {
        const p = Number(row[s]);
        if (!isNaN(p)) { tot += p; c++; }
      });
      return c ? tot / c : 0;
    }

    function computeTotalFromRow(row) {
      let tot = 0;
      SUBJECTS.forEach(s => {
        tot += Number(row[s]) || 0;
      });
      return tot;
    }

    // Form submission
    resultForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const formData = new FormData(resultForm);
      const payload = {};
      for (let [k,v] of formData.entries()) payload[k] = v;
      SUBJECTS.forEach(s => {
        payload[s] = Number(payload[s] || 0);
      });
      payload.Total = computeTotalFromRow(payload);
      const avgPercent = averagePercentFromRow(payload);
      payload.Grade = percentToGrade(avgPercent).grade;
      payload.Point = calculateGPAFromRow(payload);
      payload.Merit = meritFromGPA(payload.Point);
      payload.Timestamp = new Date().toISOString();

      if (editingId) {
        payload.action = 'update';
        payload.ID = editingId;
      } else {
        payload.action = 'add';
      }

      const res = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { 'Content-Type': 'application/json' }
      });
      const j = await res.json();
      if (j.success) {
        closeModal();
        await renderTable(document.getElementById('search').value);
      } else {
        alert('Save failed');
      }
    });

    // Search field logic: live search by roll, cross icon to clear
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clearSearch');
    searchInput.addEventListener('input', (e) => {
      const q = e.target.value.trim();
      clearBtn.style.display = q ? 'block' : 'none';
      renderTable(q);
    });
    clearBtn.addEventListener('click', () => { searchInput.value = ''; clearBtn.style.display='none'; renderTable(''); });

    // initial load
    (async () => { await renderTable(''); })();

  </script>
</body>
</html>
