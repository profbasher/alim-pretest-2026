<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Result Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small print styles for printing */
    @media print {
      body * { visibility: hidden; }
      #printable, #printable * { visibility: visible; }
      #printable { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <header class="mb-6">
      <h1 class="text-2xl md:text-3xl font-bold text-slate-800">College Result Store</h1>
    </header>

    <!-- API URL placeholder -->
    <script>
      const API_URL = 'https://script.google.com/macros/s/AKfycbyN0akGJgBiz_dGJAAjEb4GzKZ7FjFGHTP8pPrrukPaWDcZ1O8AKEqwi9zDqm4Qv7ij/exec'; // replace with your Apps Script web app URL (deployed "Anyone, even anonymous")
    </script>

    <!-- form -->
    <section class="bg-white rounded-lg shadow p-4 mb-6">
      <form id="entryForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="col-span-1 md:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-4">
          <input required id="name" name="name" placeholder="Student Name" class="p-3 border rounded" />
          <input required id="roll" name="roll" placeholder="Roll (unique)" class="p-3 border rounded" />
          <div class="flex items-center space-x-2">
            <button id="saveBtn" type="submit" class="px-4 py-2 bg-sky-600 text-white rounded">Save</button>
            <button id="clearBtn" type="button" class="px-4 py-2 border rounded">Clear</button>
            <button id="newBlankBtn" type="button" class="px-4 py-2 border rounded">New Blank</button>
          </div>
        </div>

        <!-- Subjects (list as specified) -->
        <script>
          const SUBJECTS = [
            'quran_mazid','hadis','fikah_1','fikah_2_physics_2',
            'bengali_1','bengali_2','english_1','english_2',
            'arabic_1','arabic_2_biology_2','ict','camistry_2_history',
            'mantik','civics_higher_math'
          ];
        </script>

        <div id="subjectsGrid" class="col-span-1 md:col-span-3 grid grid-cols-2 md:grid-cols-4 gap-3"></div>

        <div class="col-span-1 md:col-span-3 flex justify-end space-x-2 mt-2">
          <div class="text-sm text-slate-600">Scale: 0-100%</div>
        </div>
      </form>
    </section>

    <!-- Search -->
    <section class="mb-4">
      <div class="relative max-w-md">
        <input id="search" placeholder="Search by roll..." class="w-full p-3 pl-10 pr-10 border rounded" />
        <div class="absolute left-3 top-3 text-slate-400">
          <!-- search icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1116 4.5a7.5 7.5 0 010 12.15z" />
          </svg>
        </div>
        <button id="clearSearch" class="absolute right-2 top-2 p-1 rounded hidden" title="Clear">
          <!-- cross icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
    </section>

    <!-- headers with copy code option -->
    <section class="mb-4">
      <div class="bg-white p-3 rounded shadow">
        <div class="flex flex-wrap gap-2">
          <!-- dynamic header chips -->
          <div id="headerChips" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </section>

    <!-- results table -->
    <section>
      <div class="overflow-auto bg-white rounded shadow">
        <table id="resultsTable" class="min-w-full divide-y">
          <thead class="bg-slate-100 sticky top-0">
            <tr id="theadRow"></tr>
          </thead>
          <tbody id="tbody" class="divide-y"></tbody>
        </table>
      </div>
    </section>

    <!-- Templates / print container -->
    <div id="printable" class="hidden"></div>

  </div>

  <script>
    // helpers: grade mapping
    function percentToLetter(p) {
      if (p >= 80) return 'A+';
      if (p >= 70) return 'A';
      if (p >= 60) return 'A-';
      if (p >= 50) return 'B';
      if (p >= 40) return 'C';
      if (p >= 33) return 'D';
      return 'F';
    }
    function letterToPoint(letter) {
      switch(letter) {
        case 'A+': return 5.0;
        case 'A': return 4.0;
        case 'A-': return 3.5;
        case 'B': return 3.0;
        case 'C': return 2.0;
        case 'D': return 1.0;
        default: return 0.0;
      }
    }
    function percentToPoint(p) { return letterToPoint(percentToLetter(p)); }

    // DOM refs
    const subjectsGrid = document.getElementById('subjectsGrid');
    const theadRow = document.getElementById('theadRow');
    const tbody = document.getElementById('tbody');
    const form = document.getElementById('entryForm');
    const saveBtn = document.getElementById('saveBtn');
    const clearBtn = document.getElementById('clearBtn');
    const newBlankBtn = document.getElementById('newBlankBtn');
    const searchInput = document.getElementById('search');
    const clearSearchBtn = document.getElementById('clearSearch');
    const headerChips = document.getElementById('headerChips');
    const printable = document.getElementById('printable');

    // build inputs for subjects
    SUBJECTS.forEach(s => {
      const id = s;
      const label = s.replace(/_/g, ' ');
      const wrapper = document.createElement('div');
      wrapper.className = 'flex flex-col';
      wrapper.innerHTML = `
        <label class="text-xs text-slate-600 mb-1">${label}</label>
        <input inputmode="numeric" pattern="[0-9]*" min="0" max="100" name="${id}" id="${id}" class="p-2 border rounded" placeholder="0-100" />
      `;
      subjectsGrid.appendChild(wrapper);
    });

    // header chips (copy code)
    const ALL_HEADERS = ['name','roll',...SUBJECTS,'total','grade','point','merit','timestamp'];
    ALL_HEADERS.forEach(h => {
      const chip = document.createElement('div');
      chip.className = 'flex items-center gap-2 bg-slate-50 border px-2 py-1 rounded';
      chip.innerHTML = `
        <code class="text-xs font-mono">${h}</code>
        <button title="Copy" class="copy-btn text-slate-500 hover:text-slate-800">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
            <path d="M8 2a2 2 0 00-2 2v1H5a2 2 0 00-2 2v9a2 2 0 002 2h6a2 2 0 002-2v-1h1a2 2 0 002-2V8a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H8z" />
          </svg>
        </button>
      `;
      chip.querySelector('.copy-btn').addEventListener('click', ()=> {
        navigator.clipboard.writeText(h);
      });
      headerChips.appendChild(chip);
    });

    // build table header
    function buildTableHeader() {
      theadRow.innerHTML = '';
      ALL_HEADERS.forEach(h => {
        const th = document.createElement('th');
        th.className = 'px-3 py-2 text-left text-sm text-slate-700';
        th.textContent = h;
        theadRow.appendChild(th);
      });
      const thActions = document.createElement('th');
      thActions.className = 'px-3 py-2 text-left text-sm text-slate-700';
      thActions.textContent = 'actions';
      theadRow.appendChild(thActions);
    }

    buildTableHeader();

    // state
    let entries = []; // loaded from backend
    let editingRoll = null;

    // utility: compute totals and grade
    function computeResult(data) {
      let total = 0;
      let count = 0;
      SUBJECTS.forEach(s => {
        const v = parseFloat(data[s]);
        if (!isNaN(v)) { total += v; count++; }
      });
      const avgPercent = count ? (total / count) : 0;
      const grade = percentToLetter(avgPercent);
      // final GPA is average of grade points for each subject
      let sumPoints=0, subCount=0;
      SUBJECTS.forEach(s => {
        const v = parseFloat(data[s]);
        if (!isNaN(v)) { sumPoints += percentToPoint(v); subCount++; }
      });
      const point = subCount ? (sumPoints / subCount) : 0;
      const merit = avgPercent;
      return {
        total: parseFloat(total.toFixed(2)),
        grade,
        point: parseFloat(point.toFixed(2)),
        merit: parseFloat(merit.toFixed(2))
      };
    }

    // render table rows
    function renderRows(list) {
      tbody.innerHTML = '';
      list.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';
        // basic columns
        ALL_HEADERS.forEach(h => {
          const td = document.createElement('td');
          td.className = 'px-3 py-2 text-sm';
          let val = row[h] ?? '';
          td.textContent = val;
          tr.appendChild(td);
        });

        // actions
        const td = document.createElement('td');
        td.className = 'px-3 py-2 text-sm space-x-1';
        td.innerHTML = `
          <button class="edit text-blue-600 px-2 py-1 text-xs">Edit</button>
          <button class="view text-sky-800 px-2 py-1 text-xs">View</button>
          <button class="print text-emerald-700 px-2 py-1 text-xs">Print</button>
          <button class="del text-red-600 px-2 py-1 text-xs">Delete</button>
        `;
        tr.appendChild(td);

        // attach listeners
        td.querySelector('.edit').addEventListener('click', ()=> populateFormForEdit(row));
        td.querySelector('.view').addEventListener('click', ()=> openViewModal(row));
        td.querySelector('.print').addEventListener('click', ()=> printRow(row));
        td.querySelector('.del').addEventListener('click', ()=> deleteRow(row.roll));
        tbody.appendChild(tr);
      });
    }

    // populate form for editing
    function populateFormForEdit(row) {
      editingRoll = row.roll;
      document.getElementById('name').value = row.name || '';
      document.getElementById('roll').value = row.roll || '';
      SUBJECTS.forEach(s => {
        document.getElementById(s).value = row[s] ?? '';
      });
      window.scrollTo({top:0, behavior:'smooth'});
    }

    // view modal (simple new window)
    function openViewModal(row) {
      const html = generatePrintableHTML(row, false);
      const w = window.open('', '_blank', 'width=800,height=800');
      w.document.write(html);
      w.document.close();
    }

    // print row
    function printRow(row) {
      const html = generatePrintableHTML(row, true);
      const w = window.open('', '_blank', 'width=800,height=800');
      w.document.write(html);
      w.document.close();
      w.print();
    }

    function generatePrintableHTML(row, autoPrint=false) {
      let rowsHtml = '';
      SUBJECTS.forEach(s => {
        rowsHtml += `<tr><td style="padding:6px;border:1px solid #ddd">${s.replace(/_/g,' ')}</td><td style="padding:6px;border:1px solid #ddd">${row[s] ?? ''}</td></tr>`;
      });
      return `
        <html>
        <head>
          <meta charset="utf-8"/>
          <title>Print Result</title>
          <style>body{font-family:Helvetica,Arial,sans-serif;padding:20px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ddd;padding:8px}</style>
        </head>
        <body>
          <h2>Result: ${row.name} (${row.roll})</h2>
          <table>
            <tr><th>Subject</th><th>Marks</th></tr>
            ${rowsHtml}
            <tr><td style="padding:6px;border:1px solid #ddd">Total</td><td style="padding:6px;border:1px solid #ddd">${row.total}</td></tr>
            <tr><td style="padding:6px;border:1px solid #ddd">Average / Merit</td><td style="padding:6px;border:1px solid #ddd">${row.merit}%</td></tr>
            <tr><td style="padding:6px;border:1px solid #ddd">Grade</td><td style="padding:6px;border:1px solid #ddd">${row.grade}</td></tr>
            <tr><td style="padding:6px;border:1px solid #ddd">GPA</td><td style="padding:6px;border:1px solid #ddd">${row.point}</td></tr>
          </table>
          ${autoPrint ? '<script>window.onload=function(){window.print();}</script>' : ''}
        </body>
        </html>
      `;
    }

    // fetch all
    async function loadAll() {
      // call API list
      try {
        const res = await fetch(API_URL + '?action=list');
        const json = await res.json();
        entries = json.data || [];
        renderRows(entries);
      } catch (e) {
        console.error('load error', e);
      }
    }

    // create new entry
    async function createEntry(obj) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({action:'new-entry', data: obj})
        });
        return await res.json();
      } catch(e){ console.error(e); throw e; }
    }

    // update entry
    async function updateEntry(obj) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({action:'update', data: obj})
        });
        return await res.json();
      } catch(e){ console.error(e); throw e; }
    }

    // delete entry
    async function deleteEntryApi(roll) {
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({action:'delete', data: {roll}})
        });
        return await res.json();
      } catch(e){ console.error(e); throw e; }
    }

    // delete row
    async function deleteRow(roll) {
      if (!confirm('Delete record for roll: ' + roll + '?')) return;
      await deleteEntryApi(roll);
      await loadAll();
    }

    // form submit
    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const data = {};
      data.name = document.getElementById('name').value.trim();
      data.roll = document.getElementById('roll').value.trim();
      SUBJECTS.forEach(s => data[s] = (document.getElementById(s).value || '').trim());
      const computed = computeResult(data);
      data.total = computed.total;
      data.grade = computed.grade;
      data.point = computed.point;
      data.merit = computed.merit;
      data.timestamp = new Date().toISOString();

      try {
        if (editingRoll && editingRoll === data.roll) {
          await updateEntry(data);
        } else {
          // ensure unique roll by checking entries list
          const exists = entries.find(r => r.roll === data.roll);
          if (exists) {
            if (!confirm('Roll already exists. Overwrite?')) return;
            await updateEntry(data);
          } else {
            await createEntry(data);
          }
        }
        editingRoll = null;
        form.reset();
        await loadAll();
      } catch (e) {
        alert('Save failed');
        console.error(e);
      }
    });

    // clear form
    clearBtn.addEventListener('click', ()=> {
      form.reset();
      editingRoll = null;
    });
    newBlankBtn.addEventListener('click', ()=> {
      form.reset();
      editingRoll = null;
      document.getElementById('name').focus();
    });

    // search logic (client-side)
    searchInput.addEventListener('input', ()=> {
      const q = searchInput.value.trim();
      clearSearchBtn.classList.toggle('hidden', q.length===0);
      if (!q) {
        renderRows(entries);
        return;
      }
      const filtered = entries.filter(r => (r.roll||'').toString().toLowerCase().includes(q.toLowerCase()));
      renderRows(filtered);
    });
    clearSearchBtn.addEventListener('click', ()=> {
      searchInput.value='';
      clearSearchBtn.classList.add('hidden');
      renderRows(entries);
    });

    // initial load
    loadAll();
  </script>
</body>
</html>
