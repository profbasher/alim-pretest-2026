<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Result Store</title>

  <!-- Tailwind CDN for quick styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* small helper for input icons */
    .icon-input { padding-right: 2.5rem; }
  </style>
</head>
<body class="bg-slate-50 min-h-screen font-inter">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl sm:text-3xl font-semibold">College Result Store</h1>
      <div class="text-sm text-slate-600">Responsive • Search by Roll • Print</div>
    </header>

    <!-- copyable header string -->
    <section class="mb-4 bg-white shadow rounded p-4">
      <div class="flex items-start justify-between gap-4">
        <div>
          <div class="text-xs text-slate-500 mb-1">Google Sheet header (first row) — copy this into row 1 of "Sheet1"</div>
          <textarea id="sheetHeaders" readonly class="w-full text-xs p-2 rounded border border-slate-200" rows="2">name,roll,quran_mazid,hadis,fikah_1,fikah_2_or_physics_2,bengali_1,bengali_2,english_1,english_2,arabic_1,arabic_2_or_biology_2,ict,camistry_2_or_history,mantik,civics_or_higher_math,total,percentage,gpa,letter_grade,created_at,updated_at</textarea>
        </div>
        <div class="flex flex-col items-end gap-2">
          <button id="copyHeadersBtn" class="px-3 py-2 bg-indigo-600 text-white rounded shadow-sm text-sm">Copy code</button>
          <div class="text-xs text-slate-500">Paste into your Sheet → Sheet1 row 1</div>
        </div>
      </div>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Form -->
      <form id="resultForm" class="lg:col-span-1 bg-white p-4 rounded shadow space-y-3">
        <h2 class="font-medium">Add / Edit Result</h2>

        <div>
          <label class="block text-sm text-slate-700">Name</label>
          <input id="name" required class="w-full p-2 rounded border border-slate-200" />
        </div>

        <div>
          <label class="block text-sm text-slate-700">Roll (unique)</label>
          <input id="roll" required class="w-full p-2 rounded border border-slate-200" />
        </div>

        <div class="text-sm text-slate-600">Enter marks (0 - 100)</div>

        <div id="subjectsGrid" class="grid grid-cols-2 sm:grid-cols-3 gap-2">
          <!-- We'll dynamically populate subjects via JS -->
        </div>

        <div class="flex items-center gap-2">
          <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Save</button>
          <button type="button" id="resetBtn" class="px-3 py-2 border rounded">Reset</button>
          <div id="formMsg" class="text-sm text-red-600"></div>
        </div>

        <div class="text-xs text-slate-500">
          GPA calculation: average of grade points across subjects. Grades mapping: A+ (80-100) = 5.0, A (70-79)=4.0, A- (60-69)=3.5, B (50-59)=3.0, C (40-49)=2.0, D (33-39)=1.0, F (0-32)=0.0.
        </div>
      </form>

      <!-- Search & Actions -->
      <section class="lg:col-span-2 bg-white p-4 rounded shadow">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div class="relative w-full sm:w-1/2">
            <input id="search" placeholder="Search by roll..." class="w-full p-2 pl-3 pr-10 rounded border border-slate-200 icon-input" />
            <button id="clearSearch" title="Clear" class="absolute right-1 top-1/2 -translate-y-1/2 p-1.5 rounded-full hover:bg-slate-100">
              <!-- Cross icon -->
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>

          <div class="flex items-center gap-2">
            <button id="refreshBtn" class="px-3 py-2 border rounded text-sm">Refresh</button>
            <div id="scriptUrlBlock" class="text-xs text-slate-500">Script URL: <input id="scriptUrl" placeholder="Paste your Apps Script web app URL here" class="ml-2 text-xs border rounded p-1 w-80"/></div>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table id="resultsTable" class="min-w-full text-sm">
            <thead class="bg-slate-100">
              <tr id="tableHead"></tr>
            </thead>
            <tbody id="tableBody" class="divide-y"></tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- View/Print Modal -->
  <div id="printModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 p-4">
    <div class="bg-white max-w-3xl w-full rounded shadow p-4 overflow-auto" id="printContent">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold">Result</h3>
        <div class="flex gap-2">
          <button id="printBtn" class="px-3 py-1 bg-indigo-600 text-white rounded">Print</button>
          <button id="closePrint" class="px-3 py-1 border rounded">Close</button>
        </div>
      </div>
      <div id="printInner" class="prose"></div>
    </div>
  </div>

<script>
/* ---------- CONFIG ---------- */
/* Replace with your Apps Script Web App URL after deployment */
const SCRIPT_URL_INPUT = document.getElementById('scriptUrl');
const DEFAULT_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwjgDUNYN4HNLB-_B8fEQ2O6UBZ5P6ulnaPYTTaF2g0V-6oHGPx6NlAdtDh876BtzZ5/exec'; // leave blank — paste into UI
/* ---------- SUBJECTS ---------- */
const SUBJECTS = [
  {key:'quran_mazid', label:'Quran Mazid'},
  {key:'hadis', label:'Hadis'},
  {key:'fikah_1', label:'Fikah 1'},
  {key:'fikah_2_or_physics_2', label:'Fikah 2 / Physics 2'},
  {key:'bengali_1', label:'Bengali 1'},
  {key:'bengali_2', label:'Bengali 2'},
  {key:'english_1', label:'English 1'},
  {key:'english_2', label:'English 2'},
  {key:'arabic_1', label:'Arabic 1'},
  {key:'arabic_2_or_biology_2', label:'Arabic 2 / Biology 2'},
  {key:'ict', label:'ICT'},
  {key:'camistry_2_or_history', label:'Camistry 2 / History'},
  {key:'mantik', label:'Mantik'},
  {key:'civics_or_higher_math', label:'Civics / Higher Math'}
];

/* Grade mapping function:
   A+ 80-100 => 5.0
   A  70-79  => 4.0
   A- 60-69  => 3.5
   B  50-59  => 3.0
   C  40-49  => 2.0
   D  33-39  => 1.0
   F  0-32   => 0.0
*/
function percentToGrade(percent){
  percent = Number(percent);
  if (percent >= 80) return {letter:'A+', point:5.0};
  if (percent >= 70) return {letter:'A', point:4.0};
  if (percent >= 60) return {letter:'A-', point:3.5};
  if (percent >= 50) return {letter:'B', point:3.0};
  if (percent >= 40) return {letter:'C', point:2.0};
  if (percent >= 33) return {letter:'D', point:1.0};
  return {letter:'F', point:0.0};
}

/* ---------- UI BUILD ---------- */
const subjectsGrid = document.getElementById('subjectsGrid');
SUBJECTS.forEach(s => {
  const wrapper = document.createElement('div');
  wrapper.innerHTML = `
    <label class="block text-xs text-slate-700">${s.label}</label>
    <input type="number" min="0" max="100" id="${s.key}" class="w-full p-2 rounded border border-slate-200" />
  `;
  subjectsGrid.appendChild(wrapper);
});

/* Table head build */
const tableHead = document.getElementById('tableHead');
function buildTableHead(){
  // subjects columns
  const headers = ['name','roll', ...SUBJECTS.map(s=>s.label), 'Total', 'Grade','Point','Merit','Actions'];
  tableHead.innerHTML = '';
  headers.forEach(h => {
    const th = document.createElement('th');
    th.className = 'text-left px-2 py-2 text-xs text-slate-600';
    th.textContent = h;
    tableHead.appendChild(th);
  });
}
buildTableHead();

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const formMsg = $('formMsg');
const resultsTableBody = $('tableBody');

function getScriptUrl(){
  return SCRIPT_URL_INPUT.value.trim() || DEFAULT_SCRIPT_URL;
}

function showMsg(el, txt, t=3000){ el.textContent = txt; if(t>0) setTimeout(()=>el.textContent='', t); }

/* Copy headers */
document.getElementById('copyHeadersBtn').addEventListener('click', ()=>{
  const txt = document.getElementById('sheetHeaders').value;
  navigator.clipboard.writeText(txt).then(()=> showMsg(formMsg, 'Headers copied to clipboard',2000));
});

/* Reset form */
document.getElementById('resetBtn').addEventListener('click', resetForm);
function resetForm(){
  $('resultForm').reset();
  formMsg.textContent='';
  $('roll').disabled = false;
}

/* POST helper */
async function postToScript(body){
  const url = getScriptUrl();
  if (!url) { showMsg(formMsg, 'Paste your Apps Script web app URL above', 4000); throw 'no_url'; }
  const res = await fetch(url, {
    method:'POST',
    body: JSON.stringify(body),
    headers: {'Content-Type':'application/json'}
  });
  return res.json();
}

/* GET helper */
async function getFromScript(params){
  const url = getScriptUrl();
  if (!url) { showMsg(formMsg, 'Paste your Apps Script web app URL above', 4000); throw 'no_url'; }
  const u = new URL(url);
  Object.keys(params||{}).forEach(k => u.searchParams.set(k, params[k]));
  const res = await fetch(u.toString());
  return res.json();
}

/* ---------- Save (new or update) ---------- */
document.getElementById('resultForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = $('name').value.trim();
  const roll = $('roll').value.trim();
  if (!name || !roll) { showMsg(formMsg, 'Name and roll are required', 3000); return; }

  // collect subject marks
  const marks = {};
  let subjectCount = 0;
  let total = 0;
  SUBJECTS.forEach(s=>{
    const v = $(''+s.key).value;
    const num = v === '' ? '' : Number(v);
    marks[s.key] = num === '' ? '' : (isNaN(num) ? 0 : Math.max(0, Math.min(100, num)));
    if (marks[s.key] !== '') { total += marks[s.key]; subjectCount++; }
  });

  // Compute percentage as average of provided subjects (if none provided, percentage 0)
  const percentage = subjectCount ? (total / subjectCount) : 0;
  // For final GPA: compute grade points per subject and average across subjects that have marks
  const gradePoints = [];
  SUBJECTS.forEach(s=>{
    const val = marks[s.key];
    if (val !== '') {
      gradePoints.push(percentToGrade(val).point);
    }
  });
  const gpa = gradePoints.length ? (gradePoints.reduce((a,b)=>a+b,0)/gradePoints.length) : 0;
  const finalLetter = percentToGrade(percentage).letter;

  // build payload matching sheet headers
  const payload = {
    action: 'new-entry',
    name: name,
    roll: roll
  };
  SUBJECTS.forEach(s => payload[s.key] = marks[s.key] === '' ? '' : marks[s.key]);
  payload.total = Math.round(total*100)/100;
  payload.percentage = Math.round(percentage*100)/100;
  payload.gpa = Math.round(gpa*100)/100;
  payload.letter_grade = finalLetter;

  // Determine whether this is new or update (try to GET the roll first)
  try {
    const existing = await getFromScript({action:'get', roll: roll});
    if (existing && !existing.error) {
      // record exists -> update
      payload.action = 'update';
      const resp = await postToScript(payload);
      if (resp.ok) { showMsg(formMsg, 'Updated', 2000); await loadAll(); resetForm(); }
      else showMsg(formMsg, 'Update failed: ' + (resp.error||'unknown'), 3000);
    } else {
      // new
      const resp = await postToScript(payload);
      if (resp.ok) { showMsg(formMsg, 'Saved', 2000); await loadAll(); resetForm(); }
      else if (resp.error === 'roll_exists') showMsg(formMsg, 'Roll already exists', 3000);
      else showMsg(formMsg, 'Save failed: ' + (resp.error||'unknown'), 3000);
    }
  } catch(err){
    console.error(err);
    showMsg(formMsg, 'Request failed', 3000);
  }
});

/* ---------- Load all results ---------- */
async function loadAll(){
  try {
    const data = await getFromScript({action:'list'});
    renderTable(Array.isArray(data)?data:[]);
  } catch (err) {
    console.error(err);
    showMsg(formMsg, 'Failed to load', 3000);
  }
}

/* ---------- Render table ---------- */
function renderTable(rows){
  resultsTableBody.innerHTML = '';
  if (!rows.length) {
    resultsTableBody.innerHTML = '<tr><td colspan="'+(3+SUBJECTS.length)+'" class="px-2 py-4 text-sm text-slate-500">No records</td></tr>';
    return;
  }
  rows.forEach(r => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-slate-50';

    // name cell
    const tdName = document.createElement('td'); tdName.className='px-2 py-2'; tdName.textContent = r.name || '';
    tr.appendChild(tdName);

    // roll
    const tdRoll = document.createElement('td'); tdRoll.className='px-2 py-2 font-mono text-xs'; tdRoll.textContent = r.roll || '';
    tr.appendChild(tdRoll);

    // subjects
    let total = 0, count = 0;
    SUBJECTS.forEach(s => {
      const v = r[s.key];
      const td = document.createElement('td'); td.className='px-2 py-2 text-xs';
      if (v === '' || v === undefined) td.textContent = '-';
      else { td.textContent = v; total += Number(v); count++; }
      tr.appendChild(td);
    });

    // total
    const tdTotal = document.createElement('td'); tdTotal.className='px-2 py-2 text-xs'; tdTotal.textContent = r.total || (count ? total : '');
    tr.appendChild(tdTotal);

    // letter grade
    const tdLetter = document.createElement('td'); tdLetter.className='px-2 py-2 text-xs'; tdLetter.textContent = r.letter_grade || '';
    tr.appendChild(tdLetter);

    // point (gpa)
    const tdPoint = document.createElement('td'); tdPoint.className='px-2 py-2 text-xs'; tdPoint.textContent = r.gpa || '';
    tr.appendChild(tdPoint);

    // merit (we'll show percentage)
    const tdMerit = document.createElement('td'); tdMerit.className='px-2 py-2 text-xs'; tdMerit.textContent = r.percentage!==undefined ? r.percentage : '';
    tr.appendChild(tdMerit);

    // actions
    const tdActions = document.createElement('td'); tdActions.className='px-2 py-2 text-xs';
    tdA
