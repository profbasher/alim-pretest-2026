<!--
  index.html
  Fully responsive, mobile-friendly single-file web page.
  Replace GAS_WEBAPP_URL with your deployed Apps Script web app URL.
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>College Result Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex items-center justify-between py-4">
      <h1 class="text-2xl sm:text-3xl font-semibold">College Result Store</h1>
      <div class="hidden sm:flex space-x-2">
        <input id="searchInput" type="search" placeholder="Search by roll..." class="w-72 px-3 py-2 border rounded-md focus:outline-none" />
        <button id="clearSearch" title="Clear" class="p-2 bg-red-50 rounded-md hidden">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Form -->
      <section class="lg:col-span-1 bg-white p-4 rounded-lg shadow-sm">
        <h2 class="text-lg font-medium mb-2">Add / Edit Result</h2>
        <form id="resultForm" class="space-y-3">
          <input type="hidden" id="rowIndex" />
          <div>
            <label class="block text-sm">Name</label>
            <input id="name" required class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm">Roll</label>
            <input id="roll" required class="w-full px-3 py-2 border rounded" />
          </div>

          <!-- Subjects inputs (compact) -->
          <div class="grid grid-cols-2 gap-2">
            <div><label class="text-sm">Quran Mazid</label><input id="Quran Mazid" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Hadis</label><input id="Hadis" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Fikah 1</label><input id="Fikah 1" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Fikah 2/ Physics 2</label><input id="Fikah 2/ Physics 2" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Bengali 1</label><input id="Bengali 1" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Bengali 2</label><input id="Bengali 2" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">English 1</label><input id="English 1" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">English 2</label><input id="English 2" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Arabic 1</label><input id="Arabic 1" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Arabic 2/Biology 2</label><input id="Arabic 2/Biology 2" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">ICT</label><input id="ICT" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Camistry 2/History</label><input id="Camistry 2/History" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Mantik</label><input id="Mantik" class="w-full px-2 py-1 border rounded" /></div>
            <div><label class="text-sm">Civics/Higher Math</label><input id="Civics/Higher Math" class="w-full px-2 py-1 border rounded" /></div>
          </div>

          <div class="flex space-x-2 pt-2">
            <button type="submit" id="saveBtn" class="flex-1 px-3 py-2 bg-blue-600 text-white rounded">Save</button>
            <button type="button" id="resetBtn" class="flex-1 px-3 py-2 border rounded">Reset</button>
          </div>
        </form>
      </section>

      <!-- Table -->
      <section class="lg:col-span-2 bg-white p-4 rounded-lg shadow-sm overflow-x-auto">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-medium">Results</h2>
          <div class="flex items-center sm:hidden">
            <input id="searchInputMobile" type="search" placeholder="Search by roll..." class="w-48 px-3 py-2 border rounded-md focus:outline-none" />
            <button id="clearSearchMobile" title="Clear" class="p-2 bg-red-50 rounded-md hidden">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
        </div>

        <div class="overflow-auto">
          <table id="resultsTable" class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr id="tableHead" class="text-left">
                <!-- head generated by JS -->
              </tr>
            </thead>
            <tbody id="tableBody" class="divide-y">
              <!-- rows generated by JS -->
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<script>
/* ------------------------
   Client-side JavaScript
--------------------------- */

const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw37Phap-Q-qeS5j_23zqb2Yeutpd6SGG7SRjnsUy7DrnJq8PmJoibGEDx00SxvCUD_/exec"; // <-- replace with your deployed Apps Script web app URL

// Headers must match the Google Sheet first row exactly (case-sensitive)
const SHEET_HEADERS = [
  "name","roll",
  "Quran Mazid","Hadis","Fikah 1","Fikah 2/ Physics 2","Bengali 1","Bengali 2",
  "English 1","English 2","Arabic 1","Arabic 2/Biology 2","ICT","Camistry 2/History",
  "Mantik","Civics/Higher Math",
  "Total","Grade","Point","Merit"
];

let state = { rows: [] };

const gradeScale = (num) => {
  num = Number(num);
  if (isNaN(num)) return {grade:"F", point:0};
  if (num >= 80) return {grade:"A+", point:5.0};
  if (num >= 70) return {grade:"A", point:4.0};
  if (num >= 60) return {grade:"A-", point:3.5};
  if (num >= 50) return {grade:"B", point:3.0};
  if (num >= 40) return {grade:"C", point:2.0};
  if (num >= 33) return {grade:"D", point:1.0};
  return {grade:"F", point:0.0};
};

function calculateResult(record) {
  // Subjects are the ones from index 2 to 15 in SHEET_HEADERS
  const subjectKeys = SHEET_HEADERS.slice(2, 16);
  let totalMarks = 0;
  let countSubjects = 0;
  let totalPoints = 0;
  subjectKeys.forEach(k => {
    const v = Number(record[k]) || 0;
    totalMarks += v;
    countSubjects++;
    const gp = gradeScale(v).point;
    totalPoints += gp;
  });
  const averagePercent = countSubjects ? (totalMarks / countSubjects) : 0;
  const finalGradeObj = gradeScale(averagePercent);
  const finalPoint = countSubjects ? (totalPoints / countSubjects) : 0;
  record["Total"] = Math.round(averagePercent * 100) / 100;
  record["Grade"] = finalGradeObj.grade;
  record["Point"] = Math.round(finalPoint * 100) / 100;
  record["Merit"] = totalMarks; // storing sum of marks as merit (can be adjusted)
  return record;
}

/* --- DOM refs --- */
const tableHead = document.getElementById("tableHead");
const tableBody = document.getElementById("tableBody");
const resultForm = document.getElementById("resultForm");
const saveBtn = document.getElementById("saveBtn");
const resetBtn = document.getElementById("resetBtn");
const searchInput = document.getElementById("searchInput");
const searchInputMobile = document.getElementById("searchInputMobile");
const clearSearch = document.getElementById("clearSearch");
const clearSearchMobile = document.getElementById("clearSearchMobile");

/* Build table header */
function buildTableHeader() {
  tableHead.innerHTML = "";
  SHEET_HEADERS.forEach(h => {
    const th = document.createElement("th");
    th.className = "px-3 py-2";
    th.textContent = h;
    tableHead.appendChild(th);
  });
  const actionTh = document.createElement("th");
  actionTh.className = "px-3 py-2";
  actionTh.textContent = "Actions";
  tableHead.appendChild(actionTh);
}

/* Render rows */
function renderRows(rows) {
  tableBody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    SHEET_HEADERS.forEach(h => {
      const td = document.createElement("td");
      td.className = "px-3 py-2 align-top";
      td.textContent = r[h] !== undefined ? r[h] : "";
      tr.appendChild(td);
    });
    const tdAction = document.createElement("td");
    tdAction.className = "px-3 py-2 space-x-1";

    const viewBtn = createIconButton("View", () => onView(r), "bg-green-50 text-green-700");
    const editBtn = createIconButton("Edit", () => onEdit(r), "bg-yellow-50 text-yellow-700");
    const delBtn = createIconButton("Delete", () => onDelete(r), "bg-red-50 text-red-700");
    const printBtn = createIconButton("Print", () => onPrint(r), "bg-blue-50 text-blue-700");

    tdAction.appendChild(viewBtn);
    tdAction.appendChild(editBtn);
    tdAction.appendChild(delBtn);
    tdAction.appendChild(printBtn);
    tr.appendChild(tdAction);

    tableBody.appendChild(tr);
  });
}

function createIconButton(title, cb, extraClass="") {
  const btn = document.createElement("button");
  btn.title = title;
  btn.className = `px-2 py-1 mr-1 rounded text-xs ${extraClass}`;
  btn.textContent = title;
  btn.addEventListener("click", cb);
  return btn;
}

/* Fetch all rows from backend */
async function fetchAll() {
  try {
    const res = await fetch(GAS_WEBAPP_URL + "?action=get-all");
    const json = await res.json();
    if (json.status === "ok") {
      state.rows = json.data.map(r => {
        // ensure keys exist for all headers
        SHEET_HEADERS.forEach(h => { if (!(h in r)) r[h] = ""; });
        return r;
      });
      renderRows(state.rows);
    }
  } catch (err) {
    console.error(err);
  }
}

/* Form handlers */
resultForm.addEventListener("submit", async function(e) {
  e.preventDefault();
  const rec = {};
  SHEET_HEADERS.forEach(h => {
    rec[h] = document.getElementById(h) ? document.getElementById(h).value.trim() : "";
  });
  // name & roll
  rec["name"] = document.getElementById("name").value.trim();
  rec["roll"] = document.getElementById("roll").value.trim();

  calculateResult(rec);

  const rowIndexVal = document.getElementById("rowIndex").value;
  if (rowIndexVal) {
    // update
    await postAction("update", { rowIndex: parseInt(rowIndexVal, 10), record: rec });
    // update local state optimistically
    const idx = state.rows.findIndex(r => r._rowIndex == rowIndexVal);
    if (idx >= 0) {
      state.rows[idx] = Object.assign({}, rec, {_rowIndex: parseInt(rowIndexVal,10)});
    }
  } else {
    // insert
    await postAction("new-entry", { record: rec });
    // reload to get rowIndex
    await fetchAll();
  }
  resetForm();
  renderRows(state.rows);
});

/* Reset form */
function resetForm() {
  resultForm.reset();
  document.getElementById("rowIndex").value = "";
  window.scrollTo({top:0, behavior:"smooth"});
}

/* Edit */
function onEdit(r) {
  // populate form
  SHEET_HEADERS.forEach(h => {
    const el = document.getElementById(h);
    if (el) el.value = r[h] !== undefined ? r[h] : "";
  });
  document.getElementById("name").value = r["name"] || "";
  document.getElementById("roll").value = r["roll"] || "";
  document.getElementById("rowIndex").value = r._rowIndex || "";
  window.scrollTo({top:0, behavior:"smooth"});
}

/* View */
function onView(r) {
  const win = window.open("", "_blank", "width=800,height=600");
  const html = buildPrintHTML(r, {forPrint:false});
  win.document.write(html);
  win.document.close();
}

/* Print */
function onPrint(r) {
  const win = window.open("", "_blank", "width=800,height=600");
  const html = buildPrintHTML(r, {forPrint:true});
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(()=>{ win.print(); }, 300);
}

/* Delete */
async function onDelete(r) {
  if (!confirm("Delete this record?")) return;
  await postAction("delete", { rowIndex: r._rowIndex });
  // remove locally
  state.rows = state.rows.filter(x => x._rowIndex !== r._rowIndex);
  renderRows(state.rows);
}

/* Build printable HTML */
function buildPrintHTML(r, opts={forPrint:false}) {
  const subjectKeys = SHEET_HEADERS.slice(2,16);
  let rowsHtml = "";
  subjectKeys.forEach(k => {
    rowsHtml += `<tr><td style="padding:6px;border:1px solid #ddd">${k}</td><td style="padding:6px;border:1px solid #ddd">${r[k]||""}</td></tr>`;
  });
  const html = `
  <html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Result - ${r.name || ""}</title>
    <style>
      body{font-family:system-ui,Segoe UI,Roboto,Arial; padding:20px}
      .card{max-width:750px;margin:0 auto}
      table{border-collapse:collapse;width:100%}
    </style>
  </head>
  <body>
    <div class="card">
      <h2>Result</h2>
      <p><strong>Name:</strong> ${r.name || ""} &nbsp;&nbsp; <strong>Roll:</strong> ${r.roll || ""}</p>
      <table>
        <thead><tr><th style="text-align:left;padding:6px;border:1px solid #ddd">Subject</th><th style="text-align:left;padding:6px;border:1px solid #ddd">Marks</th></tr></thead>
        <tbody>${rowsHtml}</tbody>
      </table>
      <p><strong>Total (avg %):</strong> ${r["Total"] || ""} &nbsp; <strong>Grade:</strong> ${r["Grade"] || ""} &nbsp; <strong>Point:</strong> ${r["Point"] || ""} &nbsp; <strong>Merit:</strong> ${r["Merit"] || ""}</p>
    </div>
  </body>
  </html>`;
  return html;
}

/* POST to backend */
async function postAction(action, payload) {
  try {
    const body = { action, ...payload };
    const res = await fetch(GAS_WEBAPP_URL, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });
    return await res.json();
  } catch (err) {
    console.error(err);
  }
}

/* Search (by roll) */
function applySearch(term) {
  const t = String(term || "").trim().toLowerCase();
  if (!t) {
    renderRows(state.rows);
    return;
  }
  const filtered = state.rows.filter(r => String(r.roll || "").toLowerCase().includes(t));
  renderRows(filtered);
}

/* Wire up search inputs (no button) */
searchInput.addEventListener("input", (e) => {
  const v = e.target.value;
  applySearch(v);
  clearSearch.style.display = v ? "inline-block" : "none";
});
searchInputMobile.addEventListener("input", (e) => {
  const v = e.target.value;
  applySearch(v);
  clearSearchMobile.style.display = v ? "inline-block" : "none";
});
clearSearch.addEventListener("click", () => {
  searchInput.value = "";
  applySearch("");
  clearSearch.style.display = "none";
});
clearSearchMobile.addEventListener("click", () => {
  searchInputMobile.value = "";
  applySearch("");
  clearSearchMobile.style.display = "none";
});

/* reset button */
resetBtn.addEventListener("click", resetForm);

/* Initial */
buildTableHeader();
fetchAll();
</script>
</body>
</html>
